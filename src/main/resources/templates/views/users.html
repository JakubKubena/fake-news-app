<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head>
    <!--    <meta charset="utf-8">-->
    <!--    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>-->
    <!--    <meta name="viewport" content="width=device-width, initial-scale=1"/>-->
    <!--    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Users</title>

    <!--  jQuery & Datatables  -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>

    <!--  Bootstrap css & js  -->
    <link type="text/css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script type="text/javascript" th:src="@{/js/bootstrap.bundle.min.js}"></script>

    <!--  Bootstrap icons  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <style>
        .top-buffer { margin-top:20px; }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">User detail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row row-cols-3">
                    <div class="col">
                        <label class="form-label" for="idInput">ID:</label>
                        <input class="form-control" type="text" id="idInput" disabled>
                    </div>
                    <div class="col">
                        <label class="form-label" for="emailInput">Email:</label>
                        <input class="form-control" type="text" id="emailInput" disabled>
                    </div>
                    <div class="col">
                        <label class="form-label" for="roleInput">Role:</label>
                        <input class="form-control" type="text" id="roleInput" disabled>
                    </div>
                </div>
                <div class="row row-cols-2">
                    <div class="col">
                        <label class="form-label" for="enabledInput">Enabled:</label>
                        <input class="form-control" type="text" id="enabledInput" disabled>
                    </div>
                    <div class="col">
                        <label class="form-label" for="tokenInput">Token:</label>
                        <input class="form-control" type="text" id="tokenInput" disabled>
                    </div>
                </div>
                <div class="row row-cols-2">
                    <div class="col">
                        <label class="form-label" for="createdInput">Created:</label>
                        <input class="form-control" type="text" id="createdInput" disabled>
                    </div>
                    <div class="col">
                        <label class="form-label" for="updatedInput">Updated:</label>
                        <input class="form-control" type="text" id="updatedInput" disabled>
                    </div>
                </div>
                <div class="row row-cols-8 top-buffer">
                    <div class="col-3">
                        <button id="enabled-user-button" type="button" class="btn btn-danger"></button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-primary">Promote to ADMIN</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div th:if="${users != null && !users.isEmpty()}">
        <table class="table table-dark table-hover" id="myTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Enabled</th>
                <th>Token</th>
                <th>Role</th>
                <th>Created</th>
                <th>Updated</th>
<!--                <th>Action</th>-->
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}" data-bs-toggle="modal" data-bs-target="#detailModal"
                th:attr="data-id=''+${user.getId()}+'',
                    data-email=''+${user.getEmail()}+'',
                    data-enabled=''+${user.isEnabled()}+'',
                    data-token=''+${user.getToken()}+'',
                    data-role=''+${user.getRole().getName()}+'',
                    data-created=''+${user.getCreatedAt()}+'',
                    data-updated=''+${user.getUpdatedAt()}+''">
                <td th:text="${user.getId()}"></td>
                <td th:text="${user.getEmail()}"></td>
                <td th:text="${user.isEnabled()}"></td>
                <td th:text="${user.getToken()}"></td>
                <td th:text="${user.getRole().getName()}"></td>
                <td th:text="${#dates.format(user.getCreatedAt(), 'dd-MM-yyyy HH:mm:ss')}"></td>
                <td th:text="${#dates.format(user.getUpdatedAt(), 'dd-MM-yyyy HH:mm:ss')}"></td>
<!--                <td>-->
<!--                    &lt;!&ndash;                    <a th:href="@{'/user/' + ${user.getId()}}"><i class="bi bi-trash"></i></a>&ndash;&gt;-->
<!--                    &lt;!&ndash;                    <form th:action="@{'/user/' + ${user.getId()}}" th:method="post">&ndash;&gt;-->
<!--                    &lt;!&ndash;                        <button class="button-delete" type="submit" id="submitButton"><i class="bi bi-trash"></i></button>&ndash;&gt;-->
<!--                    &lt;!&ndash;                    </form>&ndash;&gt;-->
<!--                </td>-->
            </tr>
            </tbody>
        </table>
    </div>
</div>
<script>
    $(document).ready( function () {
        $('#myTable').DataTable();
    } );

    $('#detailModal').on('show.bs.modal', function (event) {
        let $row = $(event.relatedTarget)
        let $this = $(this)
        $this.find('#idInput').val($row.data('id'))
        $this.find('#emailInput').val($row.data('email'))
        $this.find('#enabledInput').val($row.data('enabled'))
        $this.find('#tokenInput').val($row.data('token'))
        $this.find('#roleInput').val($row.data('role'))
        $this.find('#createdInput').val($row.data('created'))
        $this.find('#updatedInput').val($row.data('updated'))

        let enabledButton = $('#enabled-user-button')
        if($('#enabledInput').val() === 'false') {
            enabledButton.removeClass('btn btn-danger').addClass('btn btn-success');
            enabledButton.html('Enable account');
        } else {
            enabledButton.removeClass('btn btn-success').addClass('btn btn-danger');
            enabledButton.html('Disable account');
        }
    })

    $(function() {
        $('#enabled-user-button').on('click', function(e) {
            let token = $("meta[name='_csrf']").attr("content");
            let header = $("meta[name='_csrf_header']").attr("content");
            let enabledValue = ($('#enabledInput').val() === 'true');
            let json = JSON.stringify({
                id: $('#idInput').val(),
                value: !enabledValue
            })
            e.preventDefault();
            $.ajax({
                method: 'PUT',
                url: 'users',
                contentType: 'application/json',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                data: json,
                success: function(response) {
                    alert(response['response']);
                },
                error: function() {
                    alert('Error');
                }
            });
            return false;
        });
    });
</script>
</body>
</html>